


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > StudentController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.uma.southdevelopers.controllers</a>
</div>

<h1>Coverage Summary for Class: StudentController (com.uma.southdevelopers.controllers)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">StudentController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (10/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (125/125)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.uma.southdevelopers.controllers;
&nbsp;
&nbsp;
&nbsp;import com.uma.southdevelopers.dtos.*;
&nbsp;
&nbsp;import com.uma.southdevelopers.entities.Enrolment;
&nbsp;import com.uma.southdevelopers.entities.Subject;
&nbsp;import com.uma.southdevelopers.entities.Institute;
&nbsp;import com.uma.southdevelopers.entities.Student;
&nbsp;import com.uma.southdevelopers.service.InstituteDBService;
&nbsp;import com.uma.southdevelopers.service.MateriaDBService;
&nbsp;import com.uma.southdevelopers.service.MatriculasDBService;
&nbsp;import com.uma.southdevelopers.service.StudentDBService;
&nbsp;import com.uma.southdevelopers.service.exceptions.EntityDoNotDeleteException;
&nbsp;import com.uma.southdevelopers.service.exceptions.EntityNotFoundException;
&nbsp;import com.uma.southdevelopers.service.exceptions.ExistingEntityDniException;
&nbsp;import org.apache.commons.csv.CSVFormat;
&nbsp;import org.apache.commons.csv.CSVParser;
&nbsp;import org.apache.commons.csv.CSVRecord;
&nbsp;import org.apache.commons.io.input.BOMInputStream;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;import org.springframework.web.multipart.MultipartFile;
&nbsp;import org.springframework.web.util.UriComponents;
&nbsp;import org.springframework.web.util.UriComponentsBuilder;
&nbsp;
&nbsp;import java.io.*;
&nbsp;import java.net.URI;
&nbsp;import java.util.*;
&nbsp;import java.util.function.Function;
&nbsp;
&nbsp;@RestController
&nbsp;@RequestMapping(path = &quot;/estudiantes&quot;)
&nbsp;public class StudentController {
&nbsp;
&nbsp;    public StudentDBService service;
&nbsp;    public InstituteDBService serviceInstitute;
&nbsp;    public MateriaDBService serviceMateria;
&nbsp;
&nbsp;    public MatriculasDBService serviceMatriculas;
&nbsp;
&nbsp;    public StudentController(StudentDBService service,
&nbsp;                             InstituteDBService serviceInstitute,
&nbsp;                             MateriaDBService serviceMateria,
<b class="fc">&nbsp;                             MatriculasDBService serviceMatriculas) {</b>
<b class="fc">&nbsp;        this.service = service;</b>
<b class="fc">&nbsp;        this.serviceInstitute = serviceInstitute;</b>
<b class="fc">&nbsp;        this.serviceMateria = serviceMateria;</b>
<b class="fc">&nbsp;        this.serviceMatriculas = serviceMatriculas;</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping
&nbsp;    public List&lt;StudentDTO&gt; obtainStudents(@RequestParam(value = &quot;idSede&quot;, required = false) Long idSede,
&nbsp;                                              @RequestParam(value = &quot;idConvocatoria&quot;, required = false) Long idConvocatoria) {
<b class="fc">&nbsp;        Long convocatoria = (idConvocatoria==null) ? 2023L : idConvocatoria;</b>
&nbsp;
<b class="fc">&nbsp;        var students = (idSede==null) ? service.allStudents() : service.obtainStudentFromSede(idSede);</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;StudentDTO&gt; studentDTOS = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;        for(Student student : students) {</b>
<b class="fc">&nbsp;            StudentDTO studentDTO = student.toDTO(convocatoria);</b>
<b class="fc">&nbsp;            if (studentDTO.getMateriasMatriculadas() != null) {</b>
<b class="fc">&nbsp;                studentDTOS.add(studentDTO);</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        return studentDTOS;</b>
&nbsp;    }
&nbsp;
&nbsp;    @PostMapping
&nbsp;    @ResponseStatus(code=HttpStatus.CREATED)
&nbsp;    public StudentDTO addStudent(@RequestBody NewStudentDTO student, UriComponentsBuilder uriBuilder) {
<b class="fc">&nbsp;        Institute institute = serviceInstitute.obtainInstitute(student.getIdInstituto());</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Subject&gt; materias = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        List&lt;Long&gt; materiasFromStudentDTO = student.getMateriasMatriculadas();</b>
&nbsp;
<b class="fc">&nbsp;        for(int i = 0; i &lt; materiasFromStudentDTO.size(); i++) {</b>
<b class="fc">&nbsp;            Optional&lt;Subject&gt; materia = serviceMateria.obtainMateria(materiasFromStudentDTO.get(i));</b>
<b class="fc">&nbsp;            if (materia.isPresent()) {</b>
<b class="fc">&nbsp;                materias.add(materia.get());</b>
&nbsp;            } else {
<b class="fc">&nbsp;                throw new EntityNotFoundException();</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        List&lt;Enrolment&gt; matriculas = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        Enrolment matricula = new Enrolment();</b>
<b class="fc">&nbsp;        matricula.setIdConvocatoria(2023L);</b>
<b class="fc">&nbsp;        matricula.setMateriasMatriculadas(materias);</b>
<b class="fc">&nbsp;        matriculas.add(matricula);</b>
&nbsp;
<b class="fc">&nbsp;        serviceMatriculas.addMatriculas(matricula);</b>
&nbsp;
<b class="fc">&nbsp;        Student stud = student.student(institute, matriculas);</b>
&nbsp;
<b class="fc">&nbsp;        Long id = service.addStudent(stud);</b>
&nbsp;
<b class="fc">&nbsp;        return stud.toDTO(2023L);</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(&quot;/{id}&quot;)
&nbsp;    @ResponseStatus(code=HttpStatus.OK)
&nbsp;    public StudentDTO obtainStudent(@PathVariable Long id, UriComponentsBuilder uriBuilder) {
<b class="fc">&nbsp;        Student student = service.obtainStudent(id);</b>
<b class="fc">&nbsp;        return StudentDTO.fromStudent(student, 2023L);</b>
&nbsp;    }
&nbsp;
&nbsp;    @PutMapping(&quot;/{id}&quot;)
&nbsp;    @ResponseStatus(code=HttpStatus.OK)
&nbsp;    public StudentDTO updateStudent(@PathVariable Long id, @RequestBody NewStudentDTO student) {
<b class="fc">&nbsp;        Institute institute = serviceInstitute.obtainInstitute(student.getIdInstituto());</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Subject&gt; materias = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        List&lt;Long&gt; materiasFromStudentDTO = student.getMateriasMatriculadas();</b>
&nbsp;
<b class="fc">&nbsp;        for (int i = 0; i &lt; materiasFromStudentDTO.size(); i++) {</b>
<b class="fc">&nbsp;            Optional&lt;Subject&gt; materia = serviceMateria.obtainMateria(materiasFromStudentDTO.get(i));</b>
<b class="fc">&nbsp;            if (materia.isPresent()) {</b>
<b class="fc">&nbsp;                materias.add(materia.get());</b>
&nbsp;            } else {
<b class="fc">&nbsp;                throw new EntityNotFoundException();</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        List&lt;Enrolment&gt; matriculas = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        Enrolment matricula = new Enrolment();</b>
<b class="fc">&nbsp;        matricula.setIdConvocatoria(2023L);</b>
<b class="fc">&nbsp;        matricula.setMateriasMatriculadas(materias);</b>
<b class="fc">&nbsp;        matriculas.add(matricula);</b>
&nbsp;
<b class="fc">&nbsp;        serviceMatriculas.addMatriculas(matricula);</b>
&nbsp;
<b class="fc">&nbsp;        Student entidadStudent = student.student(institute, matriculas);</b>
<b class="fc">&nbsp;        entidadStudent.setId(id);</b>
<b class="fc">&nbsp;        service.updateStudent(entidadStudent);</b>
<b class="fc">&nbsp;        return entidadStudent.toDTO(2023L);</b>
&nbsp;    }
&nbsp;
&nbsp;    @DeleteMapping(&quot;/{id}&quot;)
&nbsp;    public void deleteStudent(@PathVariable Long id) {
<b class="fc">&nbsp;        service.deleteStudent(id);</b>
&nbsp;    }
&nbsp;
&nbsp;    @PostMapping(&quot;/upload&quot;)
&nbsp;    public ImportacionEstudiantesDTO uploadCSV(@RequestParam(&quot;ficheroEstudiantes&quot;) MultipartFile csvFile) throws Exception {
&nbsp;
<b class="fc">&nbsp;        ImportacionEstudiantesDTO importacionEstudiantesDTO = new ImportacionEstudiantesDTO();</b>
&nbsp;
<b class="fc">&nbsp;        InputStreamReader in = new InputStreamReader(new BOMInputStream(csvFile.getInputStream()), &quot;UTF-8&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        try (BufferedReader fileReader = new BufferedReader(in);</b>
<b class="fc">&nbsp;             CSVParser csvParser = new CSVParser(fileReader,</b>
<b class="fc">&nbsp;                     CSVFormat.DEFAULT.withDelimiter(&#39;;&#39;).withFirstRecordAsHeader());) {</b>
&nbsp;
<b class="fc">&nbsp;            Iterable&lt;CSVRecord&gt; csvRecords = csvParser.getRecords();</b>
&nbsp;
<b class="fc">&nbsp;            int i = 0;</b>
<b class="fc">&nbsp;            for (CSVRecord csvRecord : csvRecords) {</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;                String[] checkMaterias = csvRecord.get(&quot;DETALLE_MATERIAS&quot;).split(&quot;,&quot;);</b>
<b class="fc">&nbsp;                Boolean existenTodasLasAsignaturas = true;</b>
&nbsp;
<b class="fc">&nbsp;                for (int j = 0; j &lt; checkMaterias.length; j++) {</b>
<b class="fc">&nbsp;                    Optional&lt;Subject&gt; enrolment = serviceMateria.obtainMateria(checkMaterias[j].trim());</b>
<b class="fc">&nbsp;                    if (enrolment.isEmpty()) {</b>
<b class="fc">&nbsp;                        existenTodasLasAsignaturas = false;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                if(serviceInstitute.checkInstitute(csvRecord.get(&quot;CENTRO&quot;)) &amp;&amp; !service.checkStudent(csvRecord.get(&quot;DNI/NIF&quot;))</b>
<b class="fc">&nbsp;                        &amp;&amp; existenTodasLasAsignaturas) {</b>
<b class="fc">&nbsp;                    Student student = new Student();</b>
<b class="fc">&nbsp;                    student.setNombre(csvRecord.get(&quot;Nombre&quot;));</b>
<b class="fc">&nbsp;                    student.setApellido1(csvRecord.get(&quot;Apellido1&quot;));</b>
<b class="fc">&nbsp;                    student.setApellido2(csvRecord.get(&quot;Apellido2&quot;));</b>
<b class="fc">&nbsp;                    student.setDni(csvRecord.get(&quot;DNI/NIF&quot;));</b>
<b class="fc">&nbsp;                    Institute institute = serviceInstitute.obtainInstitute(csvRecord.get(&quot;CENTRO&quot;));</b>
<b class="fc">&nbsp;                    student.setInstituto(institute);</b>
&nbsp;
<b class="fc">&nbsp;                    String[] materias = csvRecord.get(&quot;DETALLE_MATERIAS&quot;).split(&quot;,&quot;);</b>
<b class="fc">&nbsp;                    List&lt;Subject&gt; subjects = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;                    for (int j = 0; j &lt; materias.length; j++) {</b>
<b class="fc">&nbsp;                        Optional&lt;Subject&gt; enrolment = serviceMateria.obtainMateria(materias[j].trim());</b>
<b class="fc">&nbsp;                        if (enrolment.isPresent()) {</b>
<b class="fc">&nbsp;                            enrolment = serviceMateria.obtainMateria(materias[j].trim());</b>
<b class="fc">&nbsp;                            subjects.add(enrolment.get());</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    List&lt;Enrolment&gt; matriculas = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;                    Enrolment matricula = new Enrolment();</b>
<b class="fc">&nbsp;                    matricula.setIdConvocatoria(2023L);</b>
<b class="fc">&nbsp;                    matricula.setMateriasMatriculadas(subjects);</b>
&nbsp;
<b class="fc">&nbsp;                    matriculas.add(matricula);</b>
&nbsp;
<b class="fc">&nbsp;                    student.setMatriculas(matriculas);</b>
&nbsp;
<b class="fc">&nbsp;                    service.addStudent(student);</b>
<b class="fc">&nbsp;                    importacionEstudiantesDTO.addStudent(student.toDTO(2023L));</b>
<b class="fc">&nbsp;                } else {</b>
<b class="fc">&nbsp;                    StudentDTO student = new StudentDTO();</b>
<b class="fc">&nbsp;                    ProblemaImportacionDTO problemaImportacionDTO = new ProblemaImportacionDTO();</b>
<b class="fc">&nbsp;                    problemaImportacionDTO.setProblemaImportacion(&quot;Errores: &quot;);</b>
&nbsp;
<b class="fc">&nbsp;                    CompleteNameDTO completeNameDTO = new CompleteNameDTO();</b>
<b class="fc">&nbsp;                    completeNameDTO.setNombre(csvRecord.get(&quot;Nombre&quot;));</b>
<b class="fc">&nbsp;                    completeNameDTO.setApellido1(csvRecord.get(&quot;Apellido1&quot;));</b>
<b class="fc">&nbsp;                    completeNameDTO.setApellido2(csvRecord.get(&quot;Apellido2&quot;));</b>
<b class="fc">&nbsp;                    student.setNombreCompleto(completeNameDTO);</b>
&nbsp;
<b class="fc">&nbsp;                    if(service.checkStudent(csvRecord.get(&quot;DNI/NIF&quot;))) {</b>
<b class="fc">&nbsp;                        student.setDni(csvRecord.get(&quot;DNI/NIF&quot;));</b>
<b class="fc">&nbsp;                        problemaImportacionDTO.setProblemaImportacion(problemaImportacionDTO.getProblemaImportacion() + &quot; Ya hay un estudiante con el mismo dni,&quot;);</b>
&nbsp;                    } else {
<b class="fc">&nbsp;                        student.setDni(csvRecord.get(&quot;DNI/NIF&quot;));</b>
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    if(!serviceInstitute.checkInstitute(csvRecord.get(&quot;CENTRO&quot;))) {</b>
<b class="fc">&nbsp;                        problemaImportacionDTO.setProblemaImportacion(problemaImportacionDTO.getProblemaImportacion() + &quot; No existe el instituto,&quot;);</b>
<b class="fc">&nbsp;                        student.setInstituto(null);</b>
&nbsp;                    } else {
<b class="fc">&nbsp;                        Institute institute = serviceInstitute.obtainInstitute(csvRecord.get(&quot;CENTRO&quot;));</b>
<b class="fc">&nbsp;                        student.setInstituto(institute);</b>
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    String[] materias = csvRecord.get(&quot;DETALLE_MATERIAS&quot;).split(&quot;,&quot;);</b>
<b class="fc">&nbsp;                    List&lt;Subject&gt; subjects = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;                    for(int j = 0; j &lt; materias.length; j++) {</b>
<b class="fc">&nbsp;                        if (serviceMateria.checkMateria(materias[j].trim())) {</b>
<b class="fc">&nbsp;                            Optional&lt;Subject&gt; subject = serviceMateria.obtainMateria(materias[j].trim());</b>
<b class="fc">&nbsp;                            subjects.add(subject.get());</b>
<b class="fc">&nbsp;                        } else {</b>
<b class="fc">&nbsp;                            problemaImportacionDTO.setProblemaImportacion(problemaImportacionDTO.getProblemaImportacion() + &quot; No existe la materia &quot; + materias[j] + &quot;,&quot;);</b>
&nbsp;                        }
&nbsp;
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    student.setMateriasMatriculadas(subjects);</b>
&nbsp;
<b class="fc">&nbsp;                    problemaImportacionDTO.setEstudiante(student);</b>
&nbsp;
<b class="fc">&nbsp;                    importacionEstudiantesDTO.addProblem(problemaImportacionDTO);</b>
&nbsp;                }
&nbsp;
&nbsp;                // Codigo para parar la importacion
&nbsp;                // COMENTAR PARA IMPORTAR TODOS LOS REGISTROS
&nbsp;                /*i ++;
&nbsp;                if(i == 40){
&nbsp;                    break;
&nbsp;                }*/
&nbsp;
<b class="fc">&nbsp;            }</b>
&nbsp;
<b class="fc">&nbsp;            return importacionEstudiantesDTO;</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @ExceptionHandler(ExistingEntityDniException.class)
&nbsp;    @ResponseStatus(code = HttpStatus.CONFLICT)
<b class="fc">&nbsp;    public void existingDni() {}</b>
&nbsp;
&nbsp;    @ExceptionHandler(EntityDoNotDeleteException.class)
&nbsp;    @ResponseStatus(code = HttpStatus.CONFLICT)
<b class="fc">&nbsp;    public void doNotDelete() {}</b>
&nbsp;
&nbsp;    @ExceptionHandler(EntityNotFoundException.class)
&nbsp;    @ResponseStatus(code = HttpStatus.NOT_FOUND)
<b class="fc">&nbsp;    public void notFound() {}</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-04-24 19:08</div>
</div>
</body>
</html>
